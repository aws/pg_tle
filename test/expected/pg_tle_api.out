--  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
--
--  Licensed under the Apache License, Version 2.0 (the "License").
--  You may not use this file except in compliance with the License.
--  You may obtain a copy of the License at
--
--      http://www.apache.org/licenses/LICENSE-2.0
--
--  Unless required by applicable law or agreed to in writing, software
--  distributed under the License is distributed on an "AS IS" BASIS,
--  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
--  See the License for the specific language governing permissions and
--  limitations under the License.
-- Expect password to go through since we haven't enabled the feature
CREATE ROLE testuser with password 'pass';
-- Test 'on' / 'off' / 'require'
ALTER SYSTEM SET pgtle.enable_password_check = 'off';
SELECT pg_reload_conf();
 pg_reload_conf 
----------------
 t
(1 row)

ALTER ROLE testuser with password 'pass';
ALTER SYSTEM SET pgtle.enable_password_check = 'on';
SELECT pg_reload_conf();
 pg_reload_conf 
----------------
 t
(1 row)

-- Do not expect an error
ALTER ROLE testuser with password 'pass';
CREATE EXTENSION pg_tle;
-- Do not expect an error
ALTER ROLE testuser with password 'pass';
ALTER SYSTEM SET pgtle.enable_password_check = 'require';
SELECT pg_reload_conf();
 pg_reload_conf 
----------------
 t
(1 row)

-- Expect an error for require if no entries are present
ALTER ROLE testuser with password 'pass';
-- Insert a value into the feature table
CREATE OR REPLACE FUNCTION password_check_length_greater_than_8(username text, shadow_pass text, password_types pgtle.password_types, validuntil_time TimestampTz,validuntil_null boolean) RETURNS void AS
$$
BEGIN
if length(shadow_pass) < 8 then
  RAISE EXCEPTION 'Passwords needs to be longer than 8';
end if;
END;
$$
LANGUAGE PLPGSQL;
SELECT pgtle.pg_tle_feature_info_sql_insert('password_check_length_greater_than_8', 'passcheck');
 pg_tle_feature_info_sql_insert 
--------------------------------
 
(1 row)

-- Expect failure since pass is shorter than 8
ALTER ROLE testuser with password 'pass';
ERROR:  Passwords needs to be longer than 8
CONTEXT:  PL/pgSQL function password_check_length_greater_than_8(text,text,pgtle.password_types,timestamp with time zone,boolean) line 4 at RAISE
SQL statement "select public.password_check_length_greater_than_8('testuser', 'pass', 'PASSWORD_TYPE_PLAINTEXT', null, true)"
ALTER ROLE testuser with password 'passwords';
CREATE OR REPLACE FUNCTION password_check_only_nums(username text, shadow_pass text, password_types pgtle.password_types, validuntil_time TimestampTz,validuntil_null boolean) RETURNS void AS
$$
DECLARE x NUMERIC;
BEGIN
x = shadow_pass::NUMERIC;

EXCEPTION WHEN others THEN
RAISE EXCEPTION 'Passwords can only have numbers';
END;
$$
LANGUAGE PLPGSQL;
SELECT pgtle.pg_tle_feature_info_sql_insert('password_check_only_nums', 'passcheck');
 pg_tle_feature_info_sql_insert 
--------------------------------
 
(1 row)

-- Test both functions are called
ALTER ROLE testuser with password 'passwords';
ERROR:  Passwords can only have numbers
CONTEXT:  PL/pgSQL function password_check_only_nums(text,text,pgtle.password_types,timestamp with time zone,boolean) line 7 at RAISE
SQL statement "select public.password_check_only_nums('testuser', 'passwords', 'PASSWORD_TYPE_PLAINTEXT', null, true)"
ALTER ROLE testuser with password '123456789';
INSERT INTO pgtle.feature_info VALUES ('passcheck', '', 'password_check_only_nums', '');
-- Expect to fail cause no schema qualified function found
ALTER ROLE testuser with password '123456789';
ERROR:  Check entries in pgtle.feature_info table, schema and proname must be present
-- test insert of duplicate hook and fail
SELECT pgtle.pg_tle_feature_info_sql_insert('password_check_length_greater_than_8', 'passcheck');
ERROR:  duplicate key value violates unique constraint "feature_info_pkey"
DETAIL:  Key (feature, schema_name, proname)=(passcheck, public, password_check_length_greater_than_8) already exists.
CONTEXT:  SQL statement "INSERT INTO pgtle.feature_info VALUES (feature, proc_schema_name, proname, ident)"
PL/pgSQL function pgtle.pg_tle_feature_info_sql_insert(regproc,pgtle.pg_tle_features) line 24 at SQL statement
-- unregister hooks
SELECT pgtle.pg_tle_feature_info_sql_delete('password_check_only_nums', 'passcheck');
 pg_tle_feature_info_sql_delete 
--------------------------------
 
(1 row)

SELECT pgtle.pg_tle_feature_info_sql_delete('password_check_length_greater_than_8', 'passcheck');
 pg_tle_feature_info_sql_delete 
--------------------------------
 
(1 row)

-- fail on unregistering a hook that does not exist
SELECT pgtle.pg_tle_feature_info_sql_delete('password_check_length_greater_than_8', 'passcheck');
ERROR:  Could not unregister "password_check_length_greater_than_8": does not exist.
CONTEXT:  PL/pgSQL function pgtle.pg_tle_feature_info_sql_delete(regproc,pgtle.pg_tle_features) line 44 at RAISE
TRUNCATE TABLE pgtle.feature_info;
INSERT INTO pgtle.feature_info VALUES ('passcheck', 'public', 'test_foo;select foo()', '');
ALTER ROLE testuser with password '123456789';
ERROR:  passcheck feature does not support calling out to functions/schemas that contain ';'
HINT:  Check the pgtle.feature_info table does not contain ';' in it's entry.
DROP ROLE testuser;
ALTER SYSTEM RESET pgtle.enable_password_check;
SELECT pg_reload_conf();
 pg_reload_conf 
----------------
 t
(1 row)

DROP FUNCTION password_check_length_greater_than_8;
DROP FUNCTION password_check_only_nums;
DROP EXTENSION pg_tle;
